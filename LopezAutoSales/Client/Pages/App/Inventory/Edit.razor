@page "/app/inventory/edit/{id:int}"
@using BlazorInputFile
@inject AuthHttp auth
@inject HttpClient http
@inject IJSRuntime js
@inject CarManager carManager
@inject NavigationManager nav
@inject VINDecoder decoder

<h1 class="text-center">Edit Vehicle</h1>
@if (Car == null)
{
    <p class="lead">Could not load the vehicle.</p>
}
else
{
    <EditForm Model="Car" OnValidSubmit="EditVehicle">
        <DataAnnotationsValidator />
        <ErrorDisplay @bind-Errors="Errors" />
        <div class="form-group">
            <label>VIN</label>
            <div class="input-group">
                <InputText class="form-control" @bind-Value="Car.VIN"></InputText>
                <div class="input-group-append">
                    <button type="button" class="btn btn-secondary" @onclick="async () => await DecodeVin()">Verify</button>
                </div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-3">
                <label>Year</label>
                <InputNumber class="form-control" @bind-Value="Car.Year"></InputNumber>
            </div>
            <div class="form-group col-md-3">
                <label>Make</label>
                <InputText class="form-control" @bind-Value="Car.Make"></InputText>
            </div>
            <div class="form-group col-md-3">
                <label>Model</label>
                <InputText class="form-control" @bind-Value="Car.Model"></InputText>
            </div>
            <div class="form-group col-md-3">
                <label>Color</label>
                <InputText class="form-control" @bind-Value="Car.Color"></InputText>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-3">
                <label>Mileage</label>
                <InputNumber class="form-control" placeholder="Exempt" @bind-Value="Car.Mileage"></InputNumber>
            </div>
            <div class="form-group col-md-3">
                <label>Bought Price</label>
                <InputNumber class="form-control" @bind-Value="Car.BoughtPrice"></InputNumber>
            </div>
            <div class="form-group col-md-3">
                <label>List Price</label>
                <InputNumber class="form-control" @bind-Value="Car.ListPrice"></InputNumber>
            </div>
            <div class="form-group col-md-3 my-auto text-center">
                <div class="form-check">
                    <InputCheckbox class="form-check-input" id="salvageCheck" @bind-Value="Car.IsSalvage"></InputCheckbox>
                    <label class="form-check-label" for="salvageCheck">Is Salvage</label>
                </div>
            </div>
        </div>
        <div class="text-right">
            <button type="submit" class="btn btn-secondary">Submit</button>
        </div>
    </EditForm>
    <div class="custom-file my-3">
        <InputFile class="custom-file-input" OnChange="HandleSelection" multiple></InputFile>
        <label class="custom-file-label">
            @if (IsLoading)
            {
                <span>Loading...</span>
            }
            else
            {
                <span>Choose images</span>
            }
        </label>
    </div>
    <div class="card-deck">
        @foreach (Picture picture in Car.Pictures)
        {
            <div class="card card-picture">
                <img src="@picture.URL" class="card-img-top" />
                <div class="card-body text-center">
                    @if (!picture.IsThumbnail)
                    {
                        <button class="btn card-link" @onclick="async () => await SetThumbnail(picture)">Set Thumbnail</button>
                    }
                    <button class="btn card-link text-danger" @onclick="async () => await DeletePicture(picture)">Delete</button>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public int Id { get; set; }
    private Car Car { get; set; }
    private bool IsLoading { get; set; }
    private List<string> Errors { get; set; } = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        Car = await carManager.GetCarAsync(auth.Client, Id);
        await base.OnInitializedAsync();
    }

    private async Task EditVehicle()
    {
        await DecodeVin();
        var response = await auth.Client.PutAsJsonAsync<Car>($"/api/inventory/edit/{Id}", Car);
        if (response.IsSuccessStatusCode)
        {
            nav.NavigateTo($"/app/inventory");
        }
        else
            await js.InvokeVoidAsync("blazorAlert", response.ReasonPhrase);
    }

    private async Task HandleSelection(IFileListEntry[] files)
    {
        IsLoading = true;
        var content = new MultipartFormDataContent();
        int i = 0;
        foreach (var file in files)
        {
            var ms = new System.IO.MemoryStream();
            await file.Data.CopyToAsync(ms);
            content.Add(new ByteArrayContent(ms.GetBuffer()), $"\"upload{i}\"", file.Name);
            i++;
        }
        var response = await auth.Client.PostAsync($"/api/upload/car/{Id}", content);
        if (response.IsSuccessStatusCode)
        {
            List<Picture> pictures = await response.Content.ReadFromJsonAsync<List<Picture>>();
            Car.Pictures.AddRange(pictures);
        }
        IsLoading = false;
    }

    private async Task SetThumbnail(Picture picture)
    {
        if (!picture.IsThumbnail)
        {
            var response = await auth.Client.PutAsJsonAsync($"/api/upload/thumbnail/{picture.CarId}", picture.Id);
            if (response.IsSuccessStatusCode)
            {
                List<Picture> thumbnails = Car.Pictures.Where(x => x.IsThumbnail).ToList();
                foreach (Picture removable in thumbnails)
                    removable.IsThumbnail = false;
                picture.IsThumbnail = true;
            }
        }
    }

    private async Task DeletePicture(Picture picture)
    {
        var response = await auth.Client.DeleteAsync($"/api/upload/{picture.Id}");
        if (response.IsSuccessStatusCode)
        {
            Car.Pictures.Remove(picture);
        }
    }

    private async Task DecodeVin()
    {
        if(!await decoder.TryDecodeAsync(Car))
        {
            Errors.Clear();
            Errors.Add("Could not decode the car's VIN.");
        }
    }
}
